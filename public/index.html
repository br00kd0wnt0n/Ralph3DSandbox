<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>RALPH 3D SANDBOX</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/shaders/CopyShader.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/shaders/LuminosityHighPassShader.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/shaders/FilmShader.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/postprocessing/EffectComposer.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/postprocessing/RenderPass.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/postprocessing/ShaderPass.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/postprocessing/UnrealBloomPass.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/postprocessing/FilmPass.js"></script>
<style>
@import url('https://fonts.googleapis.com/css2?family=Space+Mono:wght@400;700&family=Bebas+Neue&family=DM+Sans:wght@300;400;500&display=swap');
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
:root{--bg:#0a0a0c;--panel:#111115;--border:#2a2a35;--accent:#e8ff47;--accent2:#ff4d8f;--accent3:#4dfff3;--text:#e0e0e8;--muted:#555568;--panel-w:300px}
body{background:var(--bg);color:var(--text);font-family:'DM Sans',sans-serif;overflow:hidden;height:100vh;width:100vw}
#canvas-container{position:fixed;inset:0;z-index:0}
#canvas-container canvas{width:100%!important;height:100%!important}
#header{position:fixed;top:0;left:0;right:0;z-index:100;display:flex;align-items:center;justify-content:space-between;padding:12px 20px;background:linear-gradient(to bottom,rgba(10,10,12,0.95),transparent);pointer-events:none}
#header-title{font-family:'Bebas Neue',sans-serif;font-size:22px;letter-spacing:3px;color:var(--accent)}
#header-sub{font-family:'Space Mono',monospace;font-size:10px;color:var(--muted);letter-spacing:1px}
#panel-toggle{position:fixed;top:14px;right:20px;z-index:200;background:var(--accent);color:var(--bg);border:none;font-family:'Space Mono',monospace;font-size:10px;font-weight:700;letter-spacing:1px;padding:8px 14px;cursor:pointer;transition:all .2s}
#panel-toggle:hover{background:var(--accent3)}
#control-panel{position:fixed;top:0;right:0;width:var(--panel-w);height:100vh;background:var(--panel);border-left:1px solid var(--border);z-index:150;overflow-y:auto;transition:transform .3s cubic-bezier(.4,0,.2,1);scrollbar-width:thin;scrollbar-color:var(--border) var(--bg)}
#control-panel.hidden{transform:translateX(100%)}
#control-panel::-webkit-scrollbar{width:3px}
#control-panel::-webkit-scrollbar-track{background:var(--bg)}
#control-panel::-webkit-scrollbar-thumb{background:var(--border)}
.panel-header{padding:52px 20px 16px;border-bottom:1px solid var(--border);position:sticky;top:0;background:var(--panel);z-index:10}
.panel-header h2{font-family:'Bebas Neue',sans-serif;font-size:18px;letter-spacing:2px;color:var(--accent);margin-bottom:4px}
.panel-header p{font-size:11px;color:var(--muted);font-family:'Space Mono',monospace}
.section{border-bottom:1px solid var(--border);overflow:hidden}
.section-header{display:flex;align-items:center;justify-content:space-between;padding:12px 20px;cursor:pointer;user-select:none;transition:background .15s}
.section-header:hover{background:rgba(255,255,255,.02)}
.section-header span{font-family:'Space Mono',monospace;font-size:10px;font-weight:700;letter-spacing:2px;color:var(--muted);text-transform:uppercase}
.section-header .arrow{font-size:10px;color:var(--muted);transition:transform .2s}
.section-header.open .arrow{transform:rotate(180deg)}
.section-header.open span{color:var(--accent)}
.section-body{padding:0 20px 16px;display:none}
.section-body.open{display:block}
.control-row{margin-bottom:14px}
.control-label{display:flex;justify-content:space-between;align-items:center;margin-bottom:6px;font-size:11px;color:var(--muted);font-family:'Space Mono',monospace}
.control-label .val{color:var(--accent3);font-size:10px}
input[type=range]{width:100%;appearance:none;height:2px;background:var(--border);outline:none;cursor:pointer}
input[type=range]::-webkit-slider-thumb{appearance:none;width:12px;height:12px;background:var(--accent);cursor:pointer;border-radius:0}
input[type=range]:hover{background:var(--muted)}
input[type=color]{width:100%;height:32px;border:1px solid var(--border);background:var(--bg);cursor:pointer;padding:2px}
input[type=text],input[type=file],select,textarea{width:100%;background:var(--bg);border:1px solid var(--border);color:var(--text);font-family:'Space Mono',monospace;font-size:11px;padding:8px 10px;outline:none;transition:border-color .2s}
input[type=text]:focus,textarea:focus{border-color:var(--accent)}
input[type=file]{padding:6px;cursor:pointer;font-size:10px}
select{cursor:pointer;appearance:none;background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='10' height='6'%3E%3Cpath d='M0 0l5 6 5-6z' fill='%23555568'/%3E%3C/svg%3E");background-repeat:no-repeat;background-position:right 10px center;padding-right:28px}
.btn-row{display:flex;gap:8px;margin-bottom:10px}
.btn{flex:1;padding:8px 10px;border:1px solid var(--border);background:transparent;color:var(--muted);font-family:'Space Mono',monospace;font-size:9px;letter-spacing:1px;cursor:pointer;transition:all .15s;text-transform:uppercase}
.btn:hover,.btn.active{border-color:var(--accent);color:var(--accent);background:rgba(232,255,71,.05)}
.btn.accent{background:var(--accent);color:var(--bg);border-color:var(--accent);font-weight:700}
.btn.accent:hover{background:var(--accent3);border-color:var(--accent3);color:var(--bg)}
.btn.danger:hover{border-color:var(--accent2);color:var(--accent2);background:rgba(255,77,143,.05)}
.toggle-row{display:flex;align-items:center;justify-content:space-between;margin-bottom:12px}
.toggle-label{font-family:'Space Mono',monospace;font-size:10px;color:var(--muted);letter-spacing:1px}
.toggle{width:32px;height:16px;background:var(--border);position:relative;cursor:pointer;transition:background .2s}
.toggle.on{background:var(--accent)}
.toggle::after{content:'';position:absolute;width:12px;height:12px;background:var(--bg);top:2px;left:2px;transition:transform .2s}
.toggle.on::after{transform:translateX(16px)}
.object-item{display:flex;align-items:center;justify-content:space-between;padding:7px 10px;border:1px solid var(--border);margin-bottom:6px;font-family:'Space Mono',monospace;font-size:10px;cursor:pointer;transition:all .15s}
.object-item:hover{border-color:var(--accent3);color:var(--accent3)}
.object-item.selected{border-color:var(--accent);color:var(--accent)}
.object-item .obj-type{color:var(--muted);font-size:9px}
.object-remove{color:var(--muted);cursor:pointer;padding:2px 5px;transition:color .15s}
.object-remove:hover{color:var(--accent2)}
.fx-badge{display:inline-block;padding:1px 5px;font-size:8px;font-family:'Space Mono',monospace;letter-spacing:1px;background:rgba(232,255,71,.12);color:var(--accent);margin-left:6px;vertical-align:middle}
.fx-divider{height:1px;background:var(--border);margin:12px 0}
.fx-section-title{font-family:'Space Mono',monospace;font-size:9px;color:var(--accent);letter-spacing:2px;margin-bottom:10px}
#share-toast{position:fixed;bottom:30px;left:50%;transform:translateX(-50%) translateY(80px);background:var(--accent);color:var(--bg);font-family:'Space Mono',monospace;font-size:11px;font-weight:700;padding:12px 24px;letter-spacing:1px;transition:transform .3s cubic-bezier(.34,1.56,.64,1);z-index:500;pointer-events:none}
#share-toast.show{transform:translateX(-50%) translateY(0)}
#cam-indicator{position:fixed;bottom:20px;left:20px;font-family:'Space Mono',monospace;font-size:10px;color:var(--muted);letter-spacing:2px;z-index:100;pointer-events:none}
#cam-indicator span{color:var(--accent3);font-weight:700}
#perf{position:fixed;bottom:38px;left:20px;font-family:'Space Mono',monospace;font-size:9px;color:var(--muted);z-index:100;pointer-events:none}
#watermark{position:fixed;bottom:20px;right:calc(var(--panel-w) + 20px);font-family:'Bebas Neue',sans-serif;font-size:13px;letter-spacing:3px;color:rgba(255,255,255,.06);z-index:100;pointer-events:none;transition:right .3s}
#watermark.panel-hidden{right:20px}
#help-bar{position:fixed;top:50%;left:20px;transform:translateY(-50%);font-family:'Space Mono',monospace;font-size:9px;color:var(--muted);line-height:2;letter-spacing:1px;z-index:100;pointer-events:none}
#help-bar div::before{content:'— ';color:var(--border)}
.ripple{position:fixed;width:20px;height:20px;border:2px solid var(--accent);border-radius:50%;pointer-events:none;z-index:400;animation:ripple-out .5s ease-out forwards;transform:translate(-50%,-50%)}
@keyframes ripple-out{to{width:60px;height:60px;opacity:0}}
</style>
</head>
<body>
<div id="canvas-container"></div>
<div id="header">
  <div>
    <div id="header-title">RALPH 3D SANDBOX</div>
    <div id="header-sub">BRANDED WORLD EXPLORER v0.2 — ATMOSPHERICS</div>
  </div>
</div>
<button id="panel-toggle">CONTROLS ▶</button>
<div id="cam-indicator">CAM: <span id="cam-mode-label">ORBIT</span></div>
<div id="perf"></div>
<div id="help-bar"><div>DRAG to orbit</div><div>SCROLL to zoom</div><div>CLICK objects</div><div>RIGHT DRAG pan</div></div>
<div id="watermark">RALPH WORLD LAB</div>
<div id="share-toast">LINK COPIED TO CLIPBOARD</div>

<div id="control-panel">
  <div class="panel-header"><h2>SCENE CONTROLS</h2><p>Tweak everything. Break things.</p></div>

  <!-- ATMOSPHERICS -->
  <div class="section">
    <div class="section-header open" onclick="toggleSection(this)"><span>Atmospherics <span class="fx-badge">FX</span></span><span class="arrow">▼</span></div>
    <div class="section-body open">
      <div class="fx-section-title">BLOOM / GLOW</div>
      <div class="toggle-row"><span class="toggle-label">ENABLED</span><div class="toggle on" id="toggle-bloom" onclick="toggleFX(this,'bloom')"></div></div>
      <div class="control-row"><div class="control-label"><span>Strength</span><span class="val" id="bloom-str-val">0.8</span></div><input type="range" id="bloom-strength" min="0" max="3" step="0.05" value="0.8"></div>
      <div class="control-row"><div class="control-label"><span>Radius</span><span class="val" id="bloom-rad-val">0.4</span></div><input type="range" id="bloom-radius" min="0" max="1" step="0.05" value="0.4"></div>
      <div class="control-row"><div class="control-label"><span>Threshold</span><span class="val" id="bloom-thr-val">0.3</span></div><input type="range" id="bloom-threshold" min="0" max="1" step="0.05" value="0.3"></div>
      <div class="fx-divider"></div>
      <div class="fx-section-title">DEPTH OF FIELD</div>
      <div class="toggle-row"><span class="toggle-label">ENABLED</span><div class="toggle" id="toggle-dof" onclick="toggleFX(this,'dof')"></div></div>
      <div class="control-row"><div class="control-label"><span>Focus Distance</span><span class="val" id="dof-focus-val">8</span></div><input type="range" id="dof-focus" min="0.5" max="30" step="0.5" value="8"></div>
      <div class="control-row"><div class="control-label"><span>Aperture</span><span class="val" id="dof-apt-val">0.015</span></div><input type="range" id="dof-aperture" min="0.001" max="0.1" step="0.001" value="0.015"></div>
      <div class="control-row"><div class="control-label"><span>Max Blur</span><span class="val" id="dof-blur-val">0.02</span></div><input type="range" id="dof-maxblur" min="0" max="0.08" step="0.002" value="0.02"></div>
      <div class="fx-divider"></div>
      <div class="fx-section-title">FILM GRAIN</div>
      <div class="toggle-row"><span class="toggle-label">ENABLED</span><div class="toggle on" id="toggle-grain" onclick="toggleFX(this,'grain')"></div></div>
      <div class="control-row"><div class="control-label"><span>Intensity</span><span class="val" id="grain-int-val">0.15</span></div><input type="range" id="grain-intensity" min="0" max="1" step="0.01" value="0.15"></div>
      <div class="toggle-row"><span class="toggle-label">SCANLINES</span><div class="toggle" id="toggle-scanlines" onclick="toggleFX(this,'scanlines')"></div></div>
      <div class="fx-divider"></div>
      <div class="fx-section-title">VIGNETTE</div>
      <div class="toggle-row"><span class="toggle-label">ENABLED</span><div class="toggle on" id="toggle-vignette" onclick="toggleFX(this,'vignette')"></div></div>
      <div class="control-row"><div class="control-label"><span>Darkness</span><span class="val" id="vig-dark-val">0.6</span></div><input type="range" id="vignette-darkness" min="0" max="2" step="0.05" value="0.6"></div>
      <div class="control-row"><div class="control-label"><span>Offset</span><span class="val" id="vig-off-val">1.0</span></div><input type="range" id="vignette-offset" min="0.1" max="2" step="0.05" value="1.0"></div>
      <div class="fx-divider"></div>
      <div class="fx-section-title">CHROMATIC ABERRATION</div>
      <div class="toggle-row"><span class="toggle-label">ENABLED</span><div class="toggle" id="toggle-chroma" onclick="toggleFX(this,'chroma')"></div></div>
      <div class="control-row"><div class="control-label"><span>Strength</span><span class="val" id="chroma-str-val">0.003</span></div><input type="range" id="chroma-strength" min="0" max="0.02" step="0.001" value="0.003"></div>
      <div class="fx-divider"></div>
      <div class="fx-section-title">DUST PARTICLES</div>
      <div class="toggle-row"><span class="toggle-label">ENABLED</span><div class="toggle on" id="toggle-dust" onclick="toggleFX(this,'dust')"></div></div>
      <div class="control-row"><div class="control-label"><span>Count</span><span class="val" id="dust-count-val">400</span></div><input type="range" id="dust-count" min="50" max="2000" step="50" value="400"></div>
      <div class="control-row"><div class="control-label"><span>Speed</span><span class="val" id="dust-speed-val">0.3</span></div><input type="range" id="dust-speed" min="0.05" max="2" step="0.05" value="0.3"></div>
      <div class="control-row"><div class="control-label"><span>Size</span><span class="val" id="dust-size-val">0.06</span></div><input type="range" id="dust-size" min="0.01" max="0.3" step="0.01" value="0.06"></div>
      <div class="control-row"><div class="control-label">Particle Color</div><input type="color" id="dust-color" value="#ffffff"></div>
    </div>
  </div>

  <!-- ENVIRONMENT -->
  <div class="section">
    <div class="section-header open" onclick="toggleSection(this)"><span>Environment</span><span class="arrow">▼</span></div>
    <div class="section-body open">
      <div class="control-row"><div class="control-label">Sky Color</div><input type="color" id="sky-color" value="#0d0d1a"></div>
      <div class="control-row"><div class="control-label">Fog Color</div><input type="color" id="fog-color" value="#0d0d1a"></div>
      <div class="control-row"><div class="control-label"><span>Fog Density</span><span class="val" id="fog-val">0.02</span></div><input type="range" id="fog-density" min="0" max="0.1" step="0.002" value="0.02"></div>
      <div class="control-row"><div class="control-label">Floor Material</div><select id="floor-material"><option value="grid">Grid</option><option value="solid">Solid Color</option><option value="checker">Checker</option><option value="none">None</option></select></div>
      <div class="control-row"><div class="control-label">Floor Color</div><input type="color" id="floor-color" value="#111122"></div>
      <div class="control-row"><div class="control-label"><span>Floor Size</span><span class="val" id="floor-size-val">30</span></div><input type="range" id="floor-size" min="10" max="100" step="5" value="30"></div>
      <div class="toggle-row"><span class="toggle-label">GRID HELPER</span><div class="toggle on" id="toggle-grid" onclick="toggleFeature(this,'grid')"></div></div>
      <div class="toggle-row"><span class="toggle-label">STARS</span><div class="toggle on" id="toggle-stars" onclick="toggleFeature(this,'stars')"></div></div>
    </div>
  </div>

  <!-- LIGHTING -->
  <div class="section">
    <div class="section-header" onclick="toggleSection(this)"><span>Lighting</span><span class="arrow">▼</span></div>
    <div class="section-body">
      <div class="control-row"><div class="control-label"><span>Ambient Intensity</span><span class="val" id="amb-val">0.3</span></div><input type="range" id="amb-intensity" min="0" max="2" step="0.05" value="0.3"></div>
      <div class="control-row"><div class="control-label">Ambient Color</div><input type="color" id="amb-color" value="#3344ff"></div>
      <div class="control-row"><div class="control-label"><span>Point Light Intensity</span><span class="val" id="pt-val">1.5</span></div><input type="range" id="pt-intensity" min="0" max="5" step="0.1" value="1.5"></div>
      <div class="control-row"><div class="control-label">Point Light Color</div><input type="color" id="pt-color" value="#e8ff47"></div>
      <div class="control-row"><div class="control-label"><span>Pt Light Height</span><span class="val" id="pth-val">5</span></div><input type="range" id="pt-height" min="0" max="20" step="0.5" value="5"></div>
      <div class="toggle-row"><span class="toggle-label">POINT LIGHT ORBIT</span><div class="toggle on" id="toggle-light-orbit" onclick="toggleFeature(this,'lightOrbit')"></div></div>
      <div class="toggle-row"><span class="toggle-label">SHADOWS</span><div class="toggle" id="toggle-shadows" onclick="toggleFeature(this,'shadows')"></div></div>
    </div>
  </div>

  <!-- CAMERA -->
  <div class="section">
    <div class="section-header" onclick="toggleSection(this)"><span>Camera</span><span class="arrow">▼</span></div>
    <div class="section-body">
      <div class="btn-row">
        <button class="btn active" id="cam-orbit" onclick="setCamera('orbit')">ORBIT</button>
        <button class="btn" id="cam-cinematic" onclick="setCamera('cinematic')">CINEMATIC</button>
        <button class="btn" id="cam-auto" onclick="setCamera('auto')">AUTO</button>
      </div>
      <div class="control-row"><div class="control-label"><span>FOV</span><span class="val" id="fov-val">60</span></div><input type="range" id="cam-fov" min="20" max="120" step="1" value="60"></div>
      <div class="control-row"><div class="control-label"><span>Cinematic Speed</span><span class="val" id="cspeed-val">0.3</span></div><input type="range" id="cam-speed" min="0.05" max="2" step="0.05" value="0.3"></div>
    </div>
  </div>

  <!-- OBJECTS -->
  <div class="section">
    <div class="section-header open" onclick="toggleSection(this)"><span>Objects</span><span class="arrow">▼</span></div>
    <div class="section-body open">
      <div class="btn-row"><button class="btn" onclick="addObject('box')">+ BOX</button><button class="btn" onclick="addObject('sphere')">+ SPHERE</button><button class="btn" onclick="addObject('cylinder')">+ CYL</button></div>
      <div class="btn-row"><button class="btn" onclick="addObject('torus')">+ TORUS</button><button class="btn" onclick="addObject('cone')">+ CONE</button><button class="btn" onclick="addObject('plane')">+ PLANE</button></div>
      <div id="objects-list"></div>
      <div id="selected-controls" style="display:none;margin-top:12px;border-top:1px solid var(--border);padding-top:12px;">
        <div style="font-family:Space Mono,monospace;font-size:9px;color:var(--accent);letter-spacing:2px;margin-bottom:10px" id="selected-label">SELECTED: —</div>
        <div class="fx-section-title">POSITION</div>
        <div class="control-row"><div class="control-label"><span>X</span><span class="val" id="pos-x-val">0</span></div><input type="range" id="obj-pos-x" min="-15" max="15" step="0.1" value="0" oninput="updateSelected('posX',this.value);document.getElementById('pos-x-val').textContent=(+this.value).toFixed(1)"></div>
        <div class="control-row"><div class="control-label"><span>Y</span><span class="val" id="pos-y-val">0</span></div><input type="range" id="obj-pos-y" min="0" max="10" step="0.1" value="0.5" oninput="updateSelected('posY',this.value);document.getElementById('pos-y-val').textContent=(+this.value).toFixed(1)"></div>
        <div class="control-row"><div class="control-label"><span>Z</span><span class="val" id="pos-z-val">0</span></div><input type="range" id="obj-pos-z" min="-15" max="15" step="0.1" value="0" oninput="updateSelected('posZ',this.value);document.getElementById('pos-z-val').textContent=(+this.value).toFixed(1)"></div>
        <div class="fx-divider"></div>
        <div class="fx-section-title">TRANSFORM</div>
        <div class="control-row"><div class="control-label"><span>Scale</span><span class="val" id="scale-val">1.0</span></div><input type="range" id="obj-scale" min="0.1" max="5" step="0.1" value="1.0" oninput="updateSelected('scale',this.value);document.getElementById('scale-val').textContent=(+this.value).toFixed(1)"></div>
        <div class="control-row"><div class="control-label"><span>Rotation Y</span><span class="val" id="rot-y-val">0</span></div><input type="range" id="obj-rot-y" min="0" max="360" step="1" value="0" oninput="updateSelected('rotY',this.value);document.getElementById('rot-y-val').textContent=this.value+'°'"></div>
        <div class="fx-divider"></div>
        <div class="fx-section-title">MATERIAL</div>
        <div class="control-row"><div class="control-label">Color</div><input type="color" id="obj-color" value="#e8ff47" onchange="updateSelected('color',this.value)"></div>
        <div class="control-row"><div class="control-label">Type</div>
          <select id="obj-material" onchange="updateSelected('material',this.value)">
            <option value="standard">Standard (PBR)</option><option value="phong">Phong</option>
            <option value="wireframe">Wireframe</option><option value="normal">Normal Map</option>
            <option value="glass">Glass</option><option value="emissive">Emissive (Glows)</option>
          </select>
        </div>
        <div class="control-row"><div class="control-label"><span>Roughness</span><span class="val" id="rough-val">0.5</span></div><input type="range" id="obj-rough" min="0" max="1" step="0.05" value="0.5" oninput="updateSelected('roughness',this.value);document.getElementById('rough-val').textContent=this.value"></div>
        <div class="control-row"><div class="control-label"><span>Metalness</span><span class="val" id="metal-val">0.1</span></div><input type="range" id="obj-metal" min="0" max="1" step="0.05" value="0.1" oninput="updateSelected('metalness',this.value);document.getElementById('metal-val').textContent=this.value"></div>
        <div class="fx-divider"></div>
        <div class="toggle-row"><span class="toggle-label">IDLE ANIMATION</span><div class="toggle on" id="toggle-anim-obj" onclick="updateSelected('animate',null,this)"></div></div>
        <button class="btn danger" onclick="removeSelected()" style="width:100%;margin-top:6px">REMOVE OBJECT</button>
      </div>
    </div>
  </div>

  <!-- PERSONALISATION -->
  <div class="section">
    <div class="section-header open" onclick="toggleSection(this)"><span>Personalisation</span><span class="arrow">▼</span></div>
    <div class="section-body open">
      <div class="control-row"><div class="control-label">Name / Text</div><input type="text" id="personal-name" placeholder="Enter a name..." value="RALPH"></div>
      <div class="control-row"><div class="control-label">Sign Text Color</div><input type="color" id="text-color" value="#e8ff47"></div>
      <div class="control-row"><div class="control-label">Sign Background</div><input type="color" id="text-bg" value="#0a0a0c"></div>
      <div class="control-row"><div class="control-label">Font Style</div>
        <select id="text-font">
          <option value="bold 80px 'Arial Black'">Impact</option>
          <option value="bold 70px Georgia">Serif Bold</option>
          <option value="60px 'Courier New'">Mono</option>
          <option value="italic bold 80px Arial">Italic Bold</option>
        </select>
      </div>
      <button class="btn accent" onclick="updateSign()" style="width:100%;margin-bottom:8px">UPDATE SIGN</button>
      <div class="toggle-row"><span class="toggle-label">SHOW SIGN</span><div class="toggle on" id="toggle-sign" onclick="toggleFeature(this,'sign')"></div></div>
    </div>
  </div>

  <!-- ASSETS -->
  <div class="section">
    <div class="section-header" onclick="toggleSection(this)"><span>Asset Import</span><span class="arrow">▼</span></div>
    <div class="section-body">
      <div style="font-family:Space Mono,monospace;font-size:9px;color:var(--muted);line-height:1.8;margin-bottom:12px">PNG becomes a textured plane. GLB loads as a 3D model.</div>
      <div class="control-row"><div class="control-label">PNG / JPG Texture</div><input type="file" id="texture-upload" accept=".png,.jpg,.jpeg,.gif,.webp" onchange="loadTexture(this)"></div>
      <div class="control-row"><div class="control-label">GLB / GLTF Model</div><input type="file" id="glb-upload" accept=".glb,.gltf" onchange="loadGLB(this)"></div>
      <div id="asset-status" style="font-family:Space Mono,monospace;font-size:9px;color:var(--accent3);margin-top:8px;min-height:16px"></div>
    </div>
  </div>

  <!-- SHARE -->
  <div class="section">
    <div class="section-header" onclick="toggleSection(this)"><span>Share</span><span class="arrow">▼</span></div>
    <div class="section-body">
      <div style="font-family:Space Mono,monospace;font-size:9px;color:var(--muted);line-height:1.8;margin-bottom:12px">Encodes scene state into a shareable URL.</div>
      <button class="btn accent" onclick="shareScene()" style="width:100%;margin-bottom:8px">COPY SCENE LINK</button>
      <button class="btn" onclick="resetScene()" style="width:100%">RESET SCENE</button>
    </div>
  </div>

  <!-- PRESETS -->
  <div class="section">
    <div class="section-header" onclick="toggleSection(this)"><span>Brand Presets</span><span class="arrow">▼</span></div>
    <div class="section-body">
      <div style="font-family:Space Mono,monospace;font-size:9px;color:var(--muted);line-height:1.8;margin-bottom:12px">One-click brand vibes. FX settings included.</div>
      <div class="btn-row"><button class="btn" onclick="applyPreset('neon')">NEON NIGHT</button><button class="btn" onclick="applyPreset('pastel')">PASTEL POP</button></div>
      <div class="btn-row"><button class="btn" onclick="applyPreset('cyber')">CYBER</button><button class="btn" onclick="applyPreset('warm')">WARM DUSK</button></div>
      <div class="btn-row"><button class="btn" onclick="applyPreset('arctic')">ARCTIC</button><button class="btn" onclick="applyPreset('forest')">FOREST</button></div>
    </div>
  </div>
</div>

<script>
// ============================================================
// CUSTOM SHADERS
// ============================================================
const VignetteShader = {
  uniforms: { tDiffuse:{value:null}, offset:{value:1.0}, darkness:{value:0.6}, enabled:{value:1.0} },
  vertexShader: `varying vec2 vUv; void main(){vUv=uv;gl_Position=projectionMatrix*modelViewMatrix*vec4(position,1.0);}`,
  fragmentShader: `uniform sampler2D tDiffuse;uniform float offset;uniform float darkness;uniform float enabled;varying vec2 vUv;
  void main(){vec4 t=texture2D(tDiffuse,vUv);if(enabled>0.5){vec2 uv=(vUv-vec2(0.5))*vec2(offset);float v=1.0-dot(uv,uv);v=clamp(pow(v,darkness),0.0,1.0);t.rgb*=v;}gl_FragColor=t;}`
};
const DOFShader = {
  uniforms: {
    tDiffuse:{value:null}, tDepth:{value:null},
    focus:{value:8.0}, aperture:{value:0.015}, maxblur:{value:0.02},
    nearClip:{value:0.1}, farClip:{value:1000.0},
    enabled:{value:0.0}, resolution:{value:new THREE.Vector2(1,1)}
  },
  vertexShader: `varying vec2 vUv; void main(){vUv=uv;gl_Position=projectionMatrix*modelViewMatrix*vec4(position,1.0);}`,
  fragmentShader: `
    uniform sampler2D tDiffuse;
    uniform sampler2D tDepth;
    uniform float focus;
    uniform float aperture;
    uniform float maxblur;
    uniform float nearClip;
    uniform float farClip;
    uniform float enabled;
    uniform vec2 resolution;
    varying vec2 vUv;

    float getDepth(vec2 uv){
      float z=texture2D(tDepth,uv).x;
      return(2.0*nearClip*farClip)/(farClip+nearClip-z*(farClip-nearClip));
    }

    void main(){
      vec4 color=texture2D(tDiffuse,vUv);
      if(enabled<0.5){gl_FragColor=color;return;}
      float depth=getDepth(vUv);
      float blur=clamp(abs(depth-focus)*aperture,0.0,maxblur);
      vec2 texel=blur/resolution;
      vec4 sum=color;
      float total=1.0;
      // 12-tap poisson disc blur
      vec2 offsets[12];
      offsets[0]=vec2(-0.326,-0.406);offsets[1]=vec2(-0.840,-0.074);
      offsets[2]=vec2(-0.696,0.457);offsets[3]=vec2(-0.203,0.621);
      offsets[4]=vec2(0.962,-0.195);offsets[5]=vec2(0.473,-0.480);
      offsets[6]=vec2(0.519,0.767);offsets[7]=vec2(0.185,-0.893);
      offsets[8]=vec2(0.507,0.064);offsets[9]=vec2(0.896,0.412);
      offsets[10]=vec2(-0.322,-0.933);offsets[11]=vec2(-0.792,-0.598);
      for(int i=0;i<12;i++){
        vec2 uv=vUv+offsets[i]*texel;
        sum+=texture2D(tDiffuse,uv);
        total+=1.0;
      }
      gl_FragColor=sum/total;
    }
  `
};

const ChromaShader = {
  uniforms: { tDiffuse:{value:null}, strength:{value:0.003}, enabled:{value:0.0} },
  vertexShader: `varying vec2 vUv; void main(){vUv=uv;gl_Position=projectionMatrix*modelViewMatrix*vec4(position,1.0);}`,
  fragmentShader: `uniform sampler2D tDiffuse;uniform float strength;uniform float enabled;varying vec2 vUv;
  void main(){vec4 t=texture2D(tDiffuse,vUv);if(enabled>0.5){vec2 o=(vUv-0.5)*strength;float r=texture2D(tDiffuse,vUv+o).r;float g=texture2D(tDiffuse,vUv).g;float b=texture2D(tDiffuse,vUv-o).b;t=vec4(r,g,b,t.a);}gl_FragColor=t;}`
};

// ============================================================
// STATE
// ============================================================
let scene,camera,renderer,composer,bloomPass,filmPass,dofPass,vignettePass,chromaPass,depthTarget;
let clock=new THREE.Clock(),frameCount=0,lastFPSTime=0;
let state={
  sky:'#0d0d1a',fogColor:'#0d0d1a',fogDensity:0.02,
  floorMaterial:'grid',floorColor:'#111122',floorSize:30,
  showGrid:true,showStars:true,
  ambIntensity:0.3,ambColor:'#3344ff',
  ptIntensity:1.5,ptColor:'#e8ff47',ptHeight:5,
  lightOrbit:true,shadows:false,
  cameraMode:'orbit',fov:60,camSpeed:0.3,
  personalName:'RALPH',textColor:'#e8ff47',textBg:'#0a0a0c',
  textFont:"bold 80px 'Arial Black'",showSign:true,
  bloomEnabled:true,bloomStrength:0.8,bloomRadius:0.4,bloomThreshold:0.3,
  dofEnabled:false,dofFocus:8,dofAperture:0.015,dofMaxBlur:0.02,
  grainEnabled:true,grainIntensity:0.15,scanlinesEnabled:false,
  vignetteEnabled:true,vignetteDarkness:0.6,vignetteOffset:1.0,
  chromaEnabled:false,chromaStrength:0.003,
  dustEnabled:true,dustCount:400,dustSpeed:0.3,dustSize:0.06,dustColor:'#ffffff'
};
let sceneObjects=[],selectedObject=null,objectIdCounter=0;
let floorMesh,gridHelper,starsObj,signMesh,dustParticles;
let pointLight,ambientLight;
let cinematicAngle=0,lightOrbitAngle=0,panelVisible=true;

// ============================================================
// ORBIT CONTROLS
// ============================================================
let orbitState={active:false,button:-1,rotateStart:new THREE.Vector2(),panStart:new THREE.Vector2()};
let spherical=new THREE.Spherical(10,Math.PI/4,Math.PI/6);
let target=new THREE.Vector3();

function initOrbitControls(){
  const el=renderer.domElement;
  el.addEventListener('mousedown',e=>{if(dragObject)return;orbitState.active=true;orbitState.button=e.button;if(e.button===0)orbitState.rotateStart.set(e.clientX,e.clientY);if(e.button===2)orbitState.panStart.set(e.clientX,e.clientY);e.preventDefault();});
  el.addEventListener('mousemove',e=>{
    if(isDragging||!orbitState.active||state.cameraMode!=='orbit')return;
    if(orbitState.button===0){const dx=(e.clientX-orbitState.rotateStart.x)/window.innerHeight*Math.PI*2;const dy=(e.clientY-orbitState.rotateStart.y)/window.innerHeight*Math.PI;spherical.theta-=dx;spherical.phi=Math.max(0.05,Math.min(Math.PI-0.05,spherical.phi-dy));orbitState.rotateStart.set(e.clientX,e.clientY);}
    if(orbitState.button===2){const dx=(e.clientX-orbitState.panStart.x)*0.01;const dy=(e.clientY-orbitState.panStart.y)*0.01;const r=new THREE.Vector3();camera.getWorldDirection(r);r.cross(camera.up).normalize().multiplyScalar(-dx);target.add(r).add(camera.up.clone().multiplyScalar(dy));orbitState.panStart.set(e.clientX,e.clientY);}
  });
  el.addEventListener('mouseup',()=>{orbitState.active=false;});
  el.addEventListener('contextmenu',e=>e.preventDefault());
  el.addEventListener('wheel',e=>{spherical.radius*=1+e.deltaY*0.001;spherical.radius=Math.max(2,Math.min(100,spherical.radius));e.preventDefault();},{passive:false});
  let ltd=0;
  el.addEventListener('touchstart',e=>{if(e.touches.length===1){orbitState.active=true;orbitState.button=0;orbitState.rotateStart.set(e.touches[0].clientX,e.touches[0].clientY);}if(e.touches.length===2){ltd=Math.hypot(e.touches[0].clientX-e.touches[1].clientX,e.touches[0].clientY-e.touches[1].clientY);}},{passive:true});
  el.addEventListener('touchmove',e=>{if(e.touches.length===1&&orbitState.active){const dx=(e.touches[0].clientX-orbitState.rotateStart.x)/window.innerHeight*Math.PI*2;const dy=(e.touches[0].clientY-orbitState.rotateStart.y)/window.innerHeight*Math.PI;spherical.theta-=dx;spherical.phi=Math.max(0.05,Math.min(Math.PI-0.05,spherical.phi-dy));orbitState.rotateStart.set(e.touches[0].clientX,e.touches[0].clientY);}if(e.touches.length===2){const d=Math.hypot(e.touches[0].clientX-e.touches[1].clientX,e.touches[0].clientY-e.touches[1].clientY);spherical.radius*=ltd/d;spherical.radius=Math.max(2,Math.min(100,spherical.radius));ltd=d;}},{passive:true});
  el.addEventListener('touchend',()=>{orbitState.active=false;});
}

function updateOrbitCamera(){camera.position.setFromSpherical(spherical).add(target);camera.lookAt(target);}

// ============================================================
// POST-PROCESSING
// ============================================================
function initComposer(){
  // Depth render target for DOF
  depthTarget=new THREE.WebGLRenderTarget(window.innerWidth,window.innerHeight);
  depthTarget.texture.minFilter=THREE.NearestFilter;
  depthTarget.texture.magFilter=THREE.NearestFilter;
  depthTarget.depthTexture=new THREE.DepthTexture();
  depthTarget.depthTexture.type=THREE.UnsignedShortType;

  composer=new THREE.EffectComposer(renderer);
  composer.addPass(new THREE.RenderPass(scene,camera));

  bloomPass=new THREE.UnrealBloomPass(new THREE.Vector2(window.innerWidth,window.innerHeight),state.bloomStrength,state.bloomRadius,state.bloomThreshold);
  bloomPass.enabled=state.bloomEnabled;
  composer.addPass(bloomPass);

  dofPass=new THREE.ShaderPass(DOFShader);
  dofPass.uniforms.focus.value=state.dofFocus;
  dofPass.uniforms.aperture.value=state.dofAperture;
  dofPass.uniforms.maxblur.value=state.dofMaxBlur;
  dofPass.uniforms.nearClip.value=camera.near;
  dofPass.uniforms.farClip.value=camera.far;
  dofPass.uniforms.enabled.value=state.dofEnabled?1.0:0.0;
  dofPass.uniforms.resolution.value.set(window.innerWidth,window.innerHeight);
  dofPass.uniforms.tDepth.value=depthTarget.depthTexture;
  composer.addPass(dofPass);

  filmPass=new THREE.FilmPass(state.grainIntensity,0.0,648,false);
  filmPass.enabled=state.grainEnabled;
  composer.addPass(filmPass);

  vignettePass=new THREE.ShaderPass(VignetteShader);
  vignettePass.uniforms.darkness.value=state.vignetteDarkness;
  vignettePass.uniforms.offset.value=state.vignetteOffset;
  vignettePass.uniforms.enabled.value=1.0;
  composer.addPass(vignettePass);

  chromaPass=new THREE.ShaderPass(ChromaShader);
  chromaPass.uniforms.strength.value=state.chromaStrength;
  chromaPass.uniforms.enabled.value=0.0;
  chromaPass.renderToScreen=true;
  composer.addPass(chromaPass);
}

// ============================================================
// FX CONTROLS
// ============================================================
function toggleFX(el,feature){
  el.classList.toggle('on');
  const on=el.classList.contains('on');
  switch(feature){
    case 'bloom': state.bloomEnabled=on; if(bloomPass)bloomPass.enabled=on; break;
    case 'dof': state.dofEnabled=on; if(dofPass)dofPass.uniforms.enabled.value=on?1.0:0.0; break;
    case 'grain': state.grainEnabled=on; if(filmPass)filmPass.enabled=on||state.scanlinesEnabled; break;
    case 'scanlines': state.scanlinesEnabled=on; if(filmPass){filmPass.uniforms.sIntensity.value=on?0.5:0.0;filmPass.enabled=state.grainEnabled||on;} break;
    case 'vignette': state.vignetteEnabled=on; if(vignettePass)vignettePass.uniforms.enabled.value=on?1.0:0.0; break;
    case 'chroma': state.chromaEnabled=on; if(chromaPass)chromaPass.uniforms.enabled.value=on?1.0:0.0; break;
    case 'dust': state.dustEnabled=on; if(dustParticles)dustParticles.visible=on; break;
  }
}

function setupFXControls(){
  bind('bloom-strength','bloom-str-val',v=>{state.bloomStrength=+v;if(bloomPass)bloomPass.strength=+v;});
  bind('bloom-radius','bloom-rad-val',v=>{state.bloomRadius=+v;if(bloomPass)bloomPass.radius=+v;});
  bind('bloom-threshold','bloom-thr-val',v=>{state.bloomThreshold=+v;if(bloomPass)bloomPass.threshold=+v;});
  bind('dof-focus','dof-focus-val',v=>{state.dofFocus=+v;if(dofPass)dofPass.uniforms.focus.value=+v;});
  bind('dof-aperture','dof-apt-val',v=>{state.dofAperture=+v;if(dofPass)dofPass.uniforms.aperture.value=+v;});
  bind('dof-maxblur','dof-blur-val',v=>{state.dofMaxBlur=+v;if(dofPass)dofPass.uniforms.maxblur.value=+v;});
  bind('grain-intensity','grain-int-val',v=>{state.grainIntensity=+v;if(filmPass)filmPass.uniforms.nIntensity.value=+v;});
  bind('vignette-darkness','vig-dark-val',v=>{state.vignetteDarkness=+v;if(vignettePass)vignettePass.uniforms.darkness.value=+v;});
  bind('vignette-offset','vig-off-val',v=>{state.vignetteOffset=+v;if(vignettePass)vignettePass.uniforms.offset.value=+v;});
  bind('chroma-strength','chroma-str-val',v=>{state.chromaStrength=+v;if(chromaPass)chromaPass.uniforms.strength.value=+v;});
  bind('dust-count','dust-count-val',v=>{state.dustCount=+v;buildDust();});
  bind('dust-speed','dust-speed-val',v=>{state.dustSpeed=+v;});
  bind('dust-size','dust-size-val',v=>{state.dustSize=+v;if(dustParticles)dustParticles.material.size=+v;});
  document.getElementById('dust-color').addEventListener('input',e=>{state.dustColor=e.target.value;if(dustParticles)dustParticles.material.color.set(e.target.value);});
}

function bind(id,valId,fn,scientific=false){
  const el=document.getElementById(id);
  if(!el)return;
  el.addEventListener('input',e=>{
    fn(e.target.value);
    const v=parseFloat(e.target.value);
    document.getElementById(valId).textContent=scientific?v.toExponential(1):v.toFixed(3).replace(/\.?0+$/,'')||'0';
  });
}

// ============================================================
// DUST PARTICLES
// ============================================================
function buildDust(){
  if(dustParticles){scene.remove(dustParticles);dustParticles.geometry.dispose();dustParticles.material.dispose();}
  const count=state.dustCount;
  const geo=new THREE.BufferGeometry();
  const pos=new Float32Array(count*3);
  const vel=new Float32Array(count*3);
  const range=20;
  for(let i=0;i<count;i++){
    pos[i*3]=(Math.random()-.5)*range;
    pos[i*3+1]=Math.random()*8;
    pos[i*3+2]=(Math.random()-.5)*range;
    vel[i*3]=(Math.random()-.5)*0.002;
    vel[i*3+1]=Math.random()*0.001+0.0005;
    vel[i*3+2]=(Math.random()-.5)*0.002;
  }
  geo.setAttribute('position',new THREE.BufferAttribute(pos,3));
  geo.setAttribute('velocity',new THREE.BufferAttribute(vel,3));
  const mat=new THREE.PointsMaterial({color:state.dustColor,size:state.dustSize,transparent:true,opacity:0.4,sizeAttenuation:true,depthWrite:false});
  dustParticles=new THREE.Points(geo,mat);
  dustParticles.visible=state.dustEnabled;
  scene.add(dustParticles);
}

function animateDust(t){
  if(!dustParticles||!dustParticles.visible)return;
  const pos=dustParticles.geometry.attributes.position.array;
  const vel=dustParticles.geometry.attributes.velocity.array;
  const count=pos.length/3;
  const sp=state.dustSpeed;
  const range=10;
  for(let i=0;i<count;i++){
    pos[i*3]+=vel[i*3]*sp+Math.sin(t*0.3+i*0.1)*0.0002;
    pos[i*3+1]+=vel[i*3+1]*sp;
    pos[i*3+2]+=vel[i*3+2]*sp;
    if(pos[i*3]>range)pos[i*3]=-range;
    if(pos[i*3]<-range)pos[i*3]=range;
    if(pos[i*3+1]>8)pos[i*3+1]=0;
    if(pos[i*3+2]>range)pos[i*3+2]=-range;
    if(pos[i*3+2]<-range)pos[i*3+2]=range;
  }
  dustParticles.geometry.attributes.position.needsUpdate=true;
}

// ============================================================
// FLOOR / GRID / STARS / SIGN
// ============================================================
function buildFloor(){
  if(floorMesh){scene.remove(floorMesh);floorMesh.geometry.dispose();}
  if(state.floorMaterial==='none')return;
  const sz=parseFloat(state.floorSize);
  const geo=new THREE.PlaneGeometry(sz,sz);
  let mat;
  if(state.floorMaterial==='grid'){
    const c=document.createElement('canvas');c.width=c.height=512;const ctx=c.getContext('2d');
    ctx.fillStyle=state.floorColor;ctx.fillRect(0,0,512,512);
    ctx.strokeStyle='rgba(255,255,255,0.08)';ctx.lineWidth=1;
    for(let i=0;i<=16;i++){const p=(512/16)*i;ctx.beginPath();ctx.moveTo(p,0);ctx.lineTo(p,512);ctx.stroke();ctx.beginPath();ctx.moveTo(0,p);ctx.lineTo(512,p);ctx.stroke();}
    const tex=new THREE.CanvasTexture(c);tex.wrapS=tex.wrapT=THREE.RepeatWrapping;tex.repeat.set(4,4);
    mat=new THREE.MeshStandardMaterial({map:tex,roughness:0.9,metalness:0});
  } else if(state.floorMaterial==='checker'){
    const c=document.createElement('canvas');c.width=c.height=512;const ctx=c.getContext('2d');
    const n=parseInt(state.floorColor.replace('#',''),16);const am=20;
    const c2=`rgb(${Math.min(255,(n>>16)+am)},${Math.min(255,((n>>8)&0xff)+am)},${Math.min(255,(n&0xff)+am)})`;
    for(let r=0;r<8;r++)for(let cc=0;cc<8;cc++){ctx.fillStyle=(r+cc)%2===0?state.floorColor:c2;ctx.fillRect(cc*64,r*64,64,64);}
    const tex=new THREE.CanvasTexture(c);tex.wrapS=tex.wrapT=THREE.RepeatWrapping;tex.repeat.set(2,2);
    mat=new THREE.MeshStandardMaterial({map:tex,roughness:0.8});
  } else {
    mat=new THREE.MeshStandardMaterial({color:state.floorColor,roughness:0.9});
  }
  floorMesh=new THREE.Mesh(geo,mat);
  floorMesh.rotation.x=-Math.PI/2;floorMesh.receiveShadow=true;
  scene.add(floorMesh);
}

function buildGrid(){
  if(gridHelper)scene.remove(gridHelper);
  if(!state.showGrid)return;
  gridHelper=new THREE.GridHelper(parseFloat(state.floorSize),20,0x222233,0x111122);
  gridHelper.position.y=0.001;scene.add(gridHelper);
}

function buildStars(){
  if(starsObj){scene.remove(starsObj);starsObj.geometry.dispose();}
  if(!state.showStars)return;
  const geo=new THREE.BufferGeometry();const v=[];
  for(let i=0;i<2000;i++){const r=200+Math.random()*300;const t=Math.random()*Math.PI*2;const p=Math.acos(2*Math.random()-1);v.push(r*Math.sin(p)*Math.cos(t),r*Math.cos(p),r*Math.sin(p)*Math.sin(t));}
  geo.setAttribute('position',new THREE.Float32BufferAttribute(v,3));
  starsObj=new THREE.Points(geo,new THREE.PointsMaterial({color:0xffffff,size:0.5,sizeAttenuation:true,transparent:true,opacity:0.6}));
  scene.add(starsObj);
}

function buildSign(){
  if(signMesh){scene.remove(signMesh);signMesh.geometry.dispose();}
  const c=document.createElement('canvas');c.width=800;c.height=200;const ctx=c.getContext('2d');
  ctx.fillStyle=state.textBg;ctx.fillRect(0,0,800,200);
  ctx.strokeStyle=state.textColor;ctx.lineWidth=6;ctx.strokeRect(6,6,788,188);
  ctx.fillStyle=state.textColor;ctx.font=state.textFont;ctx.textAlign='center';ctx.textBaseline='middle';
  ctx.fillText(state.personalName.toUpperCase(),400,100);
  const tex=new THREE.CanvasTexture(c);
  signMesh=new THREE.Mesh(new THREE.PlaneGeometry(4,1),new THREE.MeshBasicMaterial({map:tex,transparent:true}));
  signMesh.position.set(0,2.5,-3);
  if(state.showSign)scene.add(signMesh);
}

// ============================================================
// OBJECTS
// ============================================================
function addObject(type,opts={}){
  const color=opts.color||'#e8ff47';
  const x=opts.x!==undefined?opts.x:(Math.random()-.5)*6;
  const z=opts.z!==undefined?opts.z:(Math.random()-.5)*6;
  let geo;
  switch(type){
    case 'box':geo=new THREE.BoxGeometry(1,1,1);break;
    case 'sphere':geo=new THREE.SphereGeometry(0.6,32,32);break;
    case 'cylinder':geo=new THREE.CylinderGeometry(0.4,0.4,1.2,32);break;
    case 'torus':geo=new THREE.TorusGeometry(0.5,0.2,16,64);break;
    case 'cone':geo=new THREE.ConeGeometry(0.5,1.2,32);break;
    case 'plane':geo=new THREE.PlaneGeometry(1.5,1.5);break;
    default:geo=new THREE.BoxGeometry(1,1,1);
  }
  const mesh=new THREE.Mesh(geo,new THREE.MeshStandardMaterial({color,roughness:0.5,metalness:0.1}));
  mesh.position.set(x,opts.y!==undefined?opts.y:0.5,z);
  mesh.castShadow=true;
  mesh.userData={id:++objectIdCounter,type,animate:true,animOffset:Math.random()*Math.PI*2};
  scene.add(mesh);sceneObjects.push(mesh);updateObjectsList();
  return mesh;
}

function updateObjectsList(){
  const list=document.getElementById('objects-list');list.innerHTML='';
  sceneObjects.forEach(obj=>{
    const div=document.createElement('div');
    div.className='object-item'+(obj===selectedObject?' selected':'');
    div.innerHTML=`<span>${obj.userData.type.toUpperCase()} <span class="obj-type">#${obj.userData.id}</span></span><span class="object-remove" onclick="event.stopPropagation();removeObject(${obj.userData.id})">✕</span>`;
    div.addEventListener('click',()=>selectObject(obj));list.appendChild(div);
  });
}

// Helper: get all meshes inside an object (works for single Mesh or Group/GLB)
function getMeshes(obj){
  const meshes=[];
  if(obj.isMesh)meshes.push(obj);
  else obj.traverse(child=>{if(child.isMesh)meshes.push(child);});
  return meshes;
}
// Helper: get the first material color found
function getFirstColor(obj){
  const meshes=getMeshes(obj);
  for(const m of meshes){if(m.material&&m.material.color)return'#'+m.material.color.getHexString();}
  return'#e8ff47';
}
// Helper: get first roughness/metalness
function getFirstProp(obj,prop){
  const meshes=getMeshes(obj);
  for(const m of meshes){if(m.material&&m.material[prop]!==undefined)return m.material[prop];}
  return prop==='roughness'?0.5:0.1;
}

function selectObject(obj){
  selectedObject=obj;updateObjectsList();
  document.getElementById('selected-controls').style.display='block';
  document.getElementById('selected-label').textContent=`SELECTED: ${obj.userData.type.toUpperCase()} #${obj.userData.id}`;
  // Position
  document.getElementById('obj-pos-x').value=obj.position.x;
  document.getElementById('pos-x-val').textContent=obj.position.x.toFixed(1);
  document.getElementById('obj-pos-y').value=obj.position.y;
  document.getElementById('pos-y-val').textContent=obj.position.y.toFixed(1);
  document.getElementById('obj-pos-z').value=obj.position.z;
  document.getElementById('pos-z-val').textContent=obj.position.z.toFixed(1);
  // Scale
  document.getElementById('obj-scale').value=obj.scale.x;
  document.getElementById('scale-val').textContent=obj.scale.x.toFixed(1);
  // Rotation
  const rotDeg=Math.round(THREE.MathUtils.radToDeg(obj.rotation.y)%360+360)%360;
  document.getElementById('obj-rot-y').value=rotDeg;
  document.getElementById('rot-y-val').textContent=rotDeg+'°';
  // Material — read from first mesh child
  document.getElementById('obj-color').value=getFirstColor(obj);
  const rough=getFirstProp(obj,'roughness');
  document.getElementById('obj-rough').value=rough;document.getElementById('rough-val').textContent=rough;
  const metal=getFirstProp(obj,'metalness');
  document.getElementById('obj-metal').value=metal;document.getElementById('metal-val').textContent=metal;
  // Animation toggle
  document.getElementById('toggle-anim-obj').classList.toggle('on',obj.userData.animate!==false);
}

function makeMaterial(type,color){
  const c=color instanceof THREE.Color?color:new THREE.Color(color||0xffffff);
  if(type==='wireframe')return new THREE.MeshBasicMaterial({color:c,wireframe:true});
  if(type==='normal')return new THREE.MeshNormalMaterial();
  if(type==='glass')return new THREE.MeshPhysicalMaterial({color:c,transmission:0.9,transparent:true,roughness:0.05,metalness:0});
  if(type==='phong')return new THREE.MeshPhongMaterial({color:c,shininess:100});
  if(type==='emissive')return new THREE.MeshStandardMaterial({color:c,emissive:c,emissiveIntensity:1.5,roughness:0.3,metalness:0.2});
  return new THREE.MeshStandardMaterial({color:c,roughness:0.5,metalness:0.1});
}

function updateSelected(prop,value,toggleEl){
  if(!selectedObject)return;
  const meshes=getMeshes(selectedObject);
  if(prop==='posX'){selectedObject.position.x=parseFloat(value);}
  else if(prop==='posY'){selectedObject.position.y=parseFloat(value);selectedObject.userData.baseY=parseFloat(value);}
  else if(prop==='posZ'){selectedObject.position.z=parseFloat(value);}
  else if(prop==='rotY'){selectedObject.rotation.y=THREE.MathUtils.degToRad(parseFloat(value));}
  else if(prop==='color'){
    meshes.forEach(m=>{if(m.material.color)m.material.color.set(value);if(m.material.emissive)m.material.emissive.set(value);});
  }
  else if(prop==='material'){
    meshes.forEach(m=>{
      const c=m.material.color?m.material.color.clone():new THREE.Color(0xffffff);
      m.material.dispose();
      m.material=makeMaterial(value,c);
    });
  }
  else if(prop==='roughness'){const v=parseFloat(value);meshes.forEach(m=>{if(m.material.roughness!==undefined)m.material.roughness=v;});}
  else if(prop==='metalness'){const v=parseFloat(value);meshes.forEach(m=>{if(m.material.metalness!==undefined)m.material.metalness=v;});}
  else if(prop==='scale'){const s=parseFloat(value);selectedObject.scale.set(s,s,s);}
  else if(prop==='animate'){selectedObject.userData.animate=!selectedObject.userData.animate;toggleEl.classList.toggle('on',selectedObject.userData.animate);}
}

function removeObject(id){
  const idx=sceneObjects.findIndex(o=>o.userData.id===id);if(idx===-1)return;
  const obj=sceneObjects[idx];scene.remove(obj);
  obj.traverse(child=>{if(child.geometry)child.geometry.dispose();if(child.material){if(Array.isArray(child.material))child.material.forEach(m=>m.dispose());else child.material.dispose();}});
  sceneObjects.splice(idx,1);
  if(selectedObject===obj){selectedObject=null;document.getElementById('selected-controls').style.display='none';}
  updateObjectsList();
}
function removeSelected(){if(selectedObject)removeObject(selectedObject.userData.id);}

// ============================================================
// CLICK & DRAG
// ============================================================
const raycaster=new THREE.Raycaster();const mouse=new THREE.Vector2();
const groundPlane=new THREE.Plane(new THREE.Vector3(0,1,0),0);
let dragObject=null,isDragging=false,dragOffset=new THREE.Vector3(),mouseDownPos=new THREE.Vector2();

function getMouseNDC(e){
  const rect=renderer.domElement.getBoundingClientRect();
  mouse.x=((e.clientX-rect.left)/rect.width)*2-1;
  mouse.y=-((e.clientY-rect.top)/rect.height)*2+1;
}

function onPointerDown(e){
  if(e.button!==0)return;
  mouseDownPos.set(e.clientX,e.clientY);
  getMouseNDC(e);
  raycaster.setFromCamera(mouse,camera);
  const hits=raycaster.intersectObjects(sceneObjects,true);
  if(hits.length>0){
    let obj=hits[0].object;
    while(obj.parent&&!sceneObjects.includes(obj))obj=obj.parent;
    if(!sceneObjects.includes(obj))return;
    dragObject=obj;
    groundPlane.constant=-obj.position.y;
    const intersection=new THREE.Vector3();
    raycaster.ray.intersectPlane(groundPlane,intersection);
    dragOffset.copy(obj.position).sub(intersection);
    orbitState.active=false;
  }
}

function onPointerMove(e){
  if(!dragObject)return;
  const dx=e.clientX-mouseDownPos.x,dy=e.clientY-mouseDownPos.y;
  if(!isDragging&&Math.sqrt(dx*dx+dy*dy)<5)return;
  isDragging=true;
  getMouseNDC(e);
  raycaster.setFromCamera(mouse,camera);
  const intersection=new THREE.Vector3();
  if(raycaster.ray.intersectPlane(groundPlane,intersection)){
    dragObject.position.x=intersection.x+dragOffset.x;
    dragObject.position.z=intersection.z+dragOffset.z;
    if(dragObject.userData.baseY)dragObject.userData.baseY=dragObject.position.y;
    // Sync position sliders if this object is selected
    if(dragObject===selectedObject){
      document.getElementById('obj-pos-x').value=dragObject.position.x;
      document.getElementById('pos-x-val').textContent=dragObject.position.x.toFixed(1);
      document.getElementById('obj-pos-z').value=dragObject.position.z;
      document.getElementById('pos-z-val').textContent=dragObject.position.z.toFixed(1);
    }
  }
}

function onPointerUp(e){
  if(dragObject&&!isDragging){
    selectObject(dragObject);
    dragObject.userData.clickAnim={t:0,orig:dragObject.scale.x};
    spawnRipple(e.clientX,e.clientY);
  } else if(!dragObject&&!isDragging){
    // Clicked empty space — deselect
    selectedObject=null;
    document.getElementById('selected-controls').style.display='none';
    updateObjectsList();
  }
  dragObject=null;isDragging=false;
}

function spawnRipple(x,y){const r=document.createElement('div');r.className='ripple';r.style.left=x+'px';r.style.top=y+'px';document.body.appendChild(r);setTimeout(()=>r.remove(),500);}

// ============================================================
// ASSET IMPORT
// ============================================================
function loadTexture(input){
  const file=input.files[0];if(!file)return;
  new THREE.TextureLoader().load(URL.createObjectURL(file),tex=>{
    const mesh=new THREE.Mesh(new THREE.PlaneGeometry(2,2),new THREE.MeshBasicMaterial({map:tex,transparent:true,side:THREE.DoubleSide}));
    mesh.position.set(Math.random()*4-2,1,Math.random()*4-2);mesh.rotation.y=Math.random()*Math.PI*2;
    mesh.userData={id:++objectIdCounter,type:'texture',animate:true,animOffset:Math.random()*Math.PI*2};
    scene.add(mesh);sceneObjects.push(mesh);updateObjectsList();setAssetStatus(`✓ ${file.name}`);
  },undefined,()=>setAssetStatus('✗ Load failed'));
}
function loadGLB(input){
  const file=input.files[0];if(!file)return;setAssetStatus('Loading...');
  const s=document.createElement('script');s.src='https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/loaders/GLTFLoader.js';
  s.onload=()=>{
    new THREE.GLTFLoader().load(URL.createObjectURL(file),gltf=>{
      const model=gltf.scene;
      const box=new THREE.Box3().setFromObject(model);model.scale.setScalar(3/box.getSize(new THREE.Vector3()).length());
      const b2=new THREE.Box3().setFromObject(model);model.position.y=-b2.min.y;
      model.userData={id:++objectIdCounter,type:'glb',animate:false,animOffset:0};
      scene.add(model);sceneObjects.push(model);updateObjectsList();setAssetStatus(`✓ ${file.name}`);
    },undefined,()=>setAssetStatus('✗ Load failed'));
  };document.head.appendChild(s);
}
function setAssetStatus(msg){document.getElementById('asset-status').textContent=msg;setTimeout(()=>document.getElementById('asset-status').textContent='',4000);}

// ============================================================
// SIGN / CAMERA / FEATURES
// ============================================================
function updateSign(){
  state.personalName=document.getElementById('personal-name').value||'WORLD';
  state.textColor=document.getElementById('text-color').value;
  state.textBg=document.getElementById('text-bg').value;
  state.textFont=document.getElementById('text-font').value;
  buildSign();
}
function setCamera(mode){
  state.cameraMode=mode;
  document.querySelectorAll('[id^="cam-"]').forEach(b=>b.classList.remove('active'));
  const btn=document.getElementById('cam-'+mode);if(btn)btn.classList.add('active');
  document.getElementById('cam-mode-label').textContent=mode.toUpperCase();
  document.getElementById('help-bar').style.display=mode==='orbit'?'block':'none';
}
function toggleFeature(el,feature){
  el.classList.toggle('on');const on=el.classList.contains('on');
  if(feature==='grid'){state.showGrid=on;buildGrid();}
  else if(feature==='stars'){state.showStars=on;buildStars();}
  else if(feature==='lightOrbit')state.lightOrbit=on;
  else if(feature==='shadows'){state.shadows=on;renderer.shadowMap.enabled=on;scene.traverse(o=>{if(o.material)o.material.needsUpdate=true;});}
  else if(feature==='sign'){state.showSign=on;if(on)scene.add(signMesh);else scene.remove(signMesh);}
}
function toggleSection(h){h.classList.toggle('open');h.nextElementSibling.classList.toggle('open');}

// ============================================================
// RANGE / COLOR INPUTS
// ============================================================
function setupRangeInputs(){
  [
    ['fog-density','fog-val',v=>{state.fogDensity=+v;if(scene.fog)scene.fog.density=+v;}],
    ['floor-size','floor-size-val',v=>{state.floorSize=+v;buildFloor();buildGrid();}],
    ['amb-intensity','amb-val',v=>{state.ambIntensity=+v;ambientLight.intensity=+v;}],
    ['pt-intensity','pt-val',v=>{state.ptIntensity=+v;pointLight.intensity=+v;}],
    ['pt-height','pth-val',v=>{state.ptHeight=+v;pointLight.position.y=+v;}],
    ['cam-fov','fov-val',v=>{state.fov=+v;camera.fov=+v;camera.updateProjectionMatrix();}],
    ['cam-speed','cspeed-val',v=>{state.camSpeed=+v;}],
  ].forEach(([id,valId,fn])=>{
    const el=document.getElementById(id);
    if(el)el.addEventListener('input',e=>{fn(e.target.value);document.getElementById(valId).textContent=parseFloat(e.target.value).toFixed(2).replace(/\.?0+$/,'')||'0';});
  });
}
function setupColorInputs(){
  document.getElementById('sky-color').addEventListener('input',e=>{state.sky=e.target.value;scene.background.set(e.target.value);});
  document.getElementById('fog-color').addEventListener('input',e=>{state.fogColor=e.target.value;if(scene.fog)scene.fog.color.set(e.target.value);});
  document.getElementById('floor-color').addEventListener('input',e=>{state.floorColor=e.target.value;buildFloor();});
  document.getElementById('floor-material').addEventListener('change',e=>{state.floorMaterial=e.target.value;buildFloor();});
  document.getElementById('amb-color').addEventListener('input',e=>{state.ambColor=e.target.value;ambientLight.color.set(e.target.value);});
  document.getElementById('pt-color').addEventListener('input',e=>{state.ptColor=e.target.value;pointLight.color.set(e.target.value);});
}

// ============================================================
// PRESETS
// ============================================================
const presets={
  neon:{sky:'#06040f',fogColor:'#06040f',floorColor:'#0d0820',ambColor:'#220033',ptColor:'#ff00ff',fx:{bloomS:1.8,bloomR:0.6,bloomT:0.1,vigD:1.0,grainI:0.08,dustC:'#ff00ff'}},
  pastel:{sky:'#f5e6ff',fogColor:'#f5e6ff',floorColor:'#ffe8f0',ambColor:'#ffccee',ptColor:'#ff88cc',fx:{bloomS:0.4,bloomR:0.3,bloomT:0.5,vigD:0.3,grainI:0.05,dustC:'#ffccff'}},
  cyber:{sky:'#000a0a',fogColor:'#000a0a',floorColor:'#001515',ambColor:'#004444',ptColor:'#00ffff',fx:{bloomS:1.2,bloomR:0.5,bloomT:0.2,vigD:0.9,grainI:0.2,dustC:'#00ffff'}},
  warm:{sky:'#1a0a00',fogColor:'#1a0a00',floorColor:'#2a1200',ambColor:'#442200',ptColor:'#ff8833',fx:{bloomS:0.7,bloomR:0.4,bloomT:0.3,vigD:0.8,grainI:0.12,dustC:'#ffaa44'}},
  arctic:{sky:'#e8f4ff',fogColor:'#d0eaff',floorColor:'#cce8ff',ambColor:'#aaddff',ptColor:'#ffffff',fx:{bloomS:0.5,bloomR:0.3,bloomT:0.6,vigD:0.4,grainI:0.03,dustC:'#ffffff'}},
  forest:{sky:'#061208',fogColor:'#061208',floorColor:'#081a0a',ambColor:'#114422',ptColor:'#88ff44',fx:{bloomS:0.6,bloomR:0.4,bloomT:0.35,vigD:1.2,grainI:0.18,dustC:'#aaffaa'}},
};

function applyPreset(name){
  const p=presets[name];if(!p)return;
  state.sky=p.sky;scene.background.set(p.sky);
  state.fogColor=p.fogColor;if(scene.fog)scene.fog.color.set(p.fogColor);
  state.floorColor=p.floorColor;buildFloor();
  state.ambColor=p.ambColor;ambientLight.color.set(p.ambColor);
  state.ptColor=p.ptColor;pointLight.color.set(p.ptColor);
  document.getElementById('sky-color').value=p.sky;
  document.getElementById('fog-color').value=p.fogColor;
  document.getElementById('floor-color').value=p.floorColor;
  document.getElementById('amb-color').value=p.ambColor;
  document.getElementById('pt-color').value=p.ptColor;
  if(p.fx){
    const fx=p.fx;
    if(bloomPass){bloomPass.strength=fx.bloomS;bloomPass.radius=fx.bloomR;bloomPass.threshold=fx.bloomT;}
    if(filmPass)filmPass.uniforms.nIntensity.value=fx.grainI;
    if(vignettePass)vignettePass.uniforms.darkness.value=fx.vigD;
    document.getElementById('bloom-strength').value=fx.bloomS;document.getElementById('bloom-str-val').textContent=fx.bloomS;
    document.getElementById('bloom-radius').value=fx.bloomR;document.getElementById('bloom-rad-val').textContent=fx.bloomR;
    document.getElementById('bloom-threshold').value=fx.bloomT;document.getElementById('bloom-thr-val').textContent=fx.bloomT;
    document.getElementById('grain-intensity').value=fx.grainI;document.getElementById('grain-int-val').textContent=fx.grainI;
    document.getElementById('vignette-darkness').value=fx.vigD;document.getElementById('vig-dark-val').textContent=fx.vigD;
    state.dustColor=fx.dustC;document.getElementById('dust-color').value=fx.dustC;
    if(dustParticles)dustParticles.material.color.set(fx.dustC);
  }
}

// ============================================================
// SHARE
// ============================================================
function shareScene(){
  const d={
    // Environment
    sky:state.sky,fogC:state.fogColor,fogD:state.fogDensity,
    floorM:state.floorMaterial,floorC:state.floorColor,floorSz:state.floorSize,
    grid:state.showGrid,stars:state.showStars,
    // Lighting
    ambI:state.ambIntensity,ambC:state.ambColor,
    ptI:state.ptIntensity,ptC:state.ptColor,ptH:state.ptHeight,
    lOrb:state.lightOrbit,shad:state.shadows,
    // Camera
    camMode:state.cameraMode,fov:state.fov,camSpd:state.camSpeed,
    // Personalisation
    name:state.personalName,txtC:state.textColor,txtBg:state.textBg,txtF:state.textFont,sign:state.showSign,
    // Bloom
    blEn:state.bloomEnabled,blS:state.bloomStrength,blR:state.bloomRadius,blT:state.bloomThreshold,
    // DOF
    dofEn:state.dofEnabled,dofF:state.dofFocus,dofA:state.dofAperture,dofB:state.dofMaxBlur,
    // Film grain
    grEn:state.grainEnabled,grI:state.grainIntensity,scEn:state.scanlinesEnabled,
    // Vignette
    vigEn:state.vignetteEnabled,vigD:state.vignetteDarkness,vigO:state.vignetteOffset,
    // Chromatic aberration
    chEn:state.chromaEnabled,chS:state.chromaStrength,
    // Dust
    duEn:state.dustEnabled,duCt:state.dustCount,duSpd:state.dustSpeed,duSz:state.dustSize,duC:state.dustColor,
    // Objects
    objs:sceneObjects.map(o=>({
      t:o.userData.type,x:+o.position.x.toFixed(2),y:+o.position.y.toFixed(2),z:+o.position.z.toFixed(2),
      s:+o.scale.x.toFixed(2),c:o.material&&o.material.color?'#'+o.material.color.getHexString():null,
      anim:o.userData.animate
    }))
  };
  const url=`${location.origin}${location.pathname}?scene=${btoa(JSON.stringify(d))}`;
  navigator.clipboard.writeText(url).then(()=>{
    const t=document.getElementById('share-toast');t.classList.add('show');setTimeout(()=>t.classList.remove('show'),2500);
  });
}
function resetScene(){location.href=location.pathname;}

function loadFromURL(){
  const data=new URLSearchParams(location.search).get('scene');if(!data)return;
  try{
    const s=JSON.parse(atob(data));
    // Helper to set state + UI input + optional callback
    function apply(key,val,inputId,fn){
      if(val===undefined||val===null)return;
      state[key]=val;
      if(inputId){const el=document.getElementById(inputId);if(el)el.value=val;}
      if(fn)fn(val);
    }
    function applyToggle(key,val,toggleId){
      if(val===undefined||val===null)return;
      state[key]=val;
      const el=document.getElementById(toggleId);if(el)el.classList.toggle('on',val);
    }

    // Environment
    apply('sky',s.sky,'sky-color',v=>{scene.background.set(v);});
    apply('fogColor',s.fogC,'fog-color',v=>{if(scene.fog)scene.fog.color.set(v);});
    apply('fogDensity',s.fogD,'fog-density',v=>{if(scene.fog)scene.fog.density=v;document.getElementById('fog-val').textContent=v;});
    apply('floorMaterial',s.floorM,'floor-material');
    apply('floorColor',s.floorC,'floor-color');
    apply('floorSize',s.floorSz,'floor-size',v=>{document.getElementById('floor-size-val').textContent=v;});
    applyToggle('showGrid',s.grid,'toggle-grid');
    applyToggle('showStars',s.stars,'toggle-stars');

    // Lighting
    apply('ambIntensity',s.ambI,'amb-intensity',v=>{ambientLight.intensity=v;document.getElementById('amb-val').textContent=v;});
    apply('ambColor',s.ambC,'amb-color',v=>{ambientLight.color.set(v);});
    apply('ptIntensity',s.ptI,'pt-intensity',v=>{pointLight.intensity=v;document.getElementById('pt-val').textContent=v;});
    apply('ptColor',s.ptC,'pt-color',v=>{pointLight.color.set(v);});
    apply('ptHeight',s.ptH,'pt-height',v=>{pointLight.position.y=v;document.getElementById('pth-val').textContent=v;});
    applyToggle('lightOrbit',s.lOrb,'toggle-light-orbit');
    if(s.shad!==undefined){state.shadows=s.shad;renderer.shadowMap.enabled=s.shad;const el=document.getElementById('toggle-shadows');if(el)el.classList.toggle('on',s.shad);}

    // Camera
    if(s.camMode)setCamera(s.camMode);
    apply('fov',s.fov,'cam-fov',v=>{camera.fov=v;camera.updateProjectionMatrix();document.getElementById('fov-val').textContent=v;});
    apply('camSpeed',s.camSpd,'cam-speed',v=>{document.getElementById('cspeed-val').textContent=v;});

    // Personalisation
    apply('personalName',s.name,'personal-name');
    apply('textColor',s.txtC,'text-color');
    apply('textBg',s.txtBg,'text-bg');
    apply('textFont',s.txtF,'text-font');
    applyToggle('showSign',s.sign,'toggle-sign');

    // Bloom
    applyToggle('bloomEnabled',s.blEn,'toggle-bloom');
    if(s.blEn!==undefined&&bloomPass)bloomPass.enabled=s.blEn;
    apply('bloomStrength',s.blS,'bloom-strength',v=>{if(bloomPass)bloomPass.strength=v;document.getElementById('bloom-str-val').textContent=v;});
    apply('bloomRadius',s.blR,'bloom-radius',v=>{if(bloomPass)bloomPass.radius=v;document.getElementById('bloom-rad-val').textContent=v;});
    apply('bloomThreshold',s.blT,'bloom-threshold',v=>{if(bloomPass)bloomPass.threshold=v;document.getElementById('bloom-thr-val').textContent=v;});

    // DOF
    applyToggle('dofEnabled',s.dofEn,'toggle-dof');
    if(s.dofEn!==undefined&&dofPass)dofPass.uniforms.enabled.value=s.dofEn?1.0:0.0;
    apply('dofFocus',s.dofF,'dof-focus',v=>{if(dofPass)dofPass.uniforms.focus.value=v;document.getElementById('dof-focus-val').textContent=v;});
    apply('dofAperture',s.dofA,'dof-aperture',v=>{if(dofPass)dofPass.uniforms.aperture.value=v;document.getElementById('dof-apt-val').textContent=v;});
    apply('dofMaxBlur',s.dofB,'dof-maxblur',v=>{if(dofPass)dofPass.uniforms.maxblur.value=v;document.getElementById('dof-blur-val').textContent=v;});

    // Film grain
    applyToggle('grainEnabled',s.grEn,'toggle-grain');
    if(s.grEn!==undefined&&filmPass)filmPass.enabled=s.grEn||state.scanlinesEnabled;
    apply('grainIntensity',s.grI,'grain-intensity',v=>{if(filmPass)filmPass.uniforms.nIntensity.value=v;document.getElementById('grain-int-val').textContent=v;});
    applyToggle('scanlinesEnabled',s.scEn,'toggle-scanlines');
    if(s.scEn!==undefined&&filmPass){filmPass.uniforms.sIntensity.value=s.scEn?0.5:0.0;filmPass.enabled=state.grainEnabled||s.scEn;}

    // Vignette
    applyToggle('vignetteEnabled',s.vigEn,'toggle-vignette');
    if(vignettePass)vignettePass.uniforms.enabled.value=state.vignetteEnabled?1.0:0.0;
    apply('vignetteDarkness',s.vigD,'vignette-darkness',v=>{if(vignettePass)vignettePass.uniforms.darkness.value=v;document.getElementById('vig-dark-val').textContent=v;});
    apply('vignetteOffset',s.vigO,'vignette-offset',v=>{if(vignettePass)vignettePass.uniforms.offset.value=v;document.getElementById('vig-off-val').textContent=v;});

    // Chromatic aberration
    applyToggle('chromaEnabled',s.chEn,'toggle-chroma');
    if(chromaPass)chromaPass.uniforms.enabled.value=state.chromaEnabled?1.0:0.0;
    apply('chromaStrength',s.chS,'chroma-strength',v=>{if(chromaPass)chromaPass.uniforms.strength.value=v;document.getElementById('chroma-str-val').textContent=v;});

    // Dust
    applyToggle('dustEnabled',s.duEn,'toggle-dust');
    apply('dustCount',s.duCt,'dust-count',v=>{document.getElementById('dust-count-val').textContent=v;});
    apply('dustSpeed',s.duSpd,'dust-speed',v=>{document.getElementById('dust-speed-val').textContent=v;});
    apply('dustSize',s.duSz,'dust-size',v=>{document.getElementById('dust-size-val').textContent=v;});
    apply('dustColor',s.duC,'dust-color');

    // Rebuild environment
    buildFloor();buildGrid();buildStars();buildSign();buildDust();
    if(dustParticles)dustParticles.visible=state.dustEnabled;

    // Objects — clear defaults and load saved
    if(s.objs&&s.objs.length){
      sceneObjects.forEach(o=>{scene.remove(o);o.geometry.dispose();o.material.dispose();});
      sceneObjects=[];selectedObject=null;
      s.objs.forEach(o=>{
        const mesh=addObject(o.t,{x:o.x,y:o.y,z:o.z,color:o.c||'#e8ff47'});
        if(o.s)mesh.scale.setScalar(o.s);
        mesh.userData.animate=o.anim!==false;
        mesh.userData.baseY=o.y;
      });
    }
  }catch(e){console.warn('URL parse failed',e);}
}

// ============================================================
// PANEL TOGGLE
// ============================================================
document.getElementById('panel-toggle').addEventListener('click',()=>{
  panelVisible=!panelVisible;
  document.getElementById('control-panel').classList.toggle('hidden',!panelVisible);
  document.getElementById('panel-toggle').textContent=panelVisible?'CONTROLS ▶':'CONTROLS ◀';
  document.getElementById('watermark').classList.toggle('panel-hidden',!panelVisible);
});

// ============================================================
// INIT
// ============================================================
function init(){
  scene=new THREE.Scene();
  scene.background=new THREE.Color(state.sky);
  scene.fog=new THREE.FogExp2(state.fogColor,state.fogDensity);

  camera=new THREE.PerspectiveCamera(state.fov,window.innerWidth/window.innerHeight,0.1,1000);
  camera.position.set(6,4,10);camera.lookAt(0,0,0);

  renderer=new THREE.WebGLRenderer({antialias:true});
  renderer.setPixelRatio(Math.min(window.devicePixelRatio,2));
  renderer.setSize(window.innerWidth,window.innerHeight);
  renderer.shadowMap.enabled=false;renderer.shadowMap.type=THREE.PCFSoftShadowMap;
  renderer.toneMapping=THREE.ACESFilmicToneMapping;renderer.toneMappingExposure=1.0;
  document.getElementById('canvas-container').appendChild(renderer.domElement);

  initOrbitControls();

  ambientLight=new THREE.AmbientLight(state.ambColor,state.ambIntensity);scene.add(ambientLight);
  pointLight=new THREE.PointLight(state.ptColor,state.ptIntensity,80);pointLight.position.set(3,state.ptHeight,3);scene.add(pointLight);
  scene.add(new THREE.HemisphereLight('#111133','#001100',0.2));

  buildFloor();buildGrid();buildStars();buildSign();buildDust();

  addObject('box',{x:-2,y:0.5,z:0,color:'#4dfff3'});
  addObject('sphere',{x:0,y:0.8,z:0,color:'#e8ff47'});
  addObject('torus',{x:2.2,y:0.7,z:0,color:'#ff4d8f'});

  initComposer();

  window.addEventListener('resize',onResize);
  renderer.domElement.addEventListener('pointerdown',onPointerDown);
  renderer.domElement.addEventListener('pointermove',onPointerMove);
  renderer.domElement.addEventListener('pointerup',onPointerUp);
  loadFromURL();
  animate();
}

// ============================================================
// ANIMATE
// ============================================================
function animate(){
  requestAnimationFrame(animate);
  const t=clock.getElapsedTime();

  frameCount++;
  if(t-lastFPSTime>=1){document.getElementById('perf').textContent=`${frameCount} FPS`;frameCount=0;lastFPSTime=t;}

  sceneObjects.forEach(obj=>{
    if(obj.userData.animate&&obj!==dragObject){
      const o=obj.userData.animOffset||0;
      if(obj.userData.type!=='glb'&&obj.userData.type!=='texture'){
        obj.rotation.y=t*0.4+o;
        if(!obj.userData.baseY)obj.userData.baseY=obj.position.y;
        obj.position.y=obj.userData.baseY+Math.sin(t*0.8+o)*0.08;
      }
    }
    if(obj.userData.clickAnim){
      obj.userData.clickAnim.t+=0.08;
      const ct=obj.userData.clickAnim.t;
      if(ct<1)obj.scale.setScalar(obj.userData.clickAnim.orig*(1+Math.sin(ct*Math.PI)*0.3));
      else{obj.scale.setScalar(obj.userData.clickAnim.orig);delete obj.userData.clickAnim;}
    }
  });

  if(state.lightOrbit){lightOrbitAngle+=0.01;pointLight.position.x=Math.cos(lightOrbitAngle)*6;pointLight.position.z=Math.sin(lightOrbitAngle)*6;}

  if(state.cameraMode==='orbit')updateOrbitCamera();
  else if(state.cameraMode==='auto'){spherical.theta+=0.003;updateOrbitCamera();}
  else if(state.cameraMode==='cinematic'){
    cinematicAngle+=state.camSpeed*0.005;
    camera.position.set(Math.cos(cinematicAngle)*10,3+Math.sin(cinematicAngle*0.3)*2,Math.sin(cinematicAngle)*10);
    camera.lookAt(0,1,0);
  }

  if(signMesh)signMesh.position.y=2.5+Math.sin(t*0.5)*0.05;
  animateDust(t);
  if(filmPass&&filmPass.uniforms.time)filmPass.uniforms.time.value=t;

  // Render depth pass for DOF
  if(depthTarget&&state.dofEnabled){renderer.setRenderTarget(depthTarget);renderer.render(scene,camera);renderer.setRenderTarget(null);}
  if(composer)composer.render();else renderer.render(scene,camera);
}

function onResize(){
  camera.aspect=window.innerWidth/window.innerHeight;camera.updateProjectionMatrix();
  renderer.setSize(window.innerWidth,window.innerHeight);
  if(composer)composer.setSize(window.innerWidth,window.innerHeight);
  if(bloomPass)bloomPass.resolution.set(window.innerWidth,window.innerHeight);
  if(depthTarget)depthTarget.setSize(window.innerWidth,window.innerHeight);
  if(dofPass)dofPass.uniforms.resolution.value.set(window.innerWidth,window.innerHeight);
}

setupRangeInputs();setupColorInputs();setupFXControls();
init();
</script>
</body>
</html>
